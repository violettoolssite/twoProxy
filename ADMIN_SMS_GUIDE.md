# 管理员SMS次数管理指南

## 访问权限

**管理后台地址**: `https://mirror.yljdteam.com/admin/`

**授权账号**:
- `violet@yljdteam.com`
- `1494458927@qq.com`

**权限控制**:
- 后端白名单验证
- 前端自动检测并重定向非授权用户

## 功能概述

### 1. 统计面板

实时显示以下数据：
- **总用户数**: 系统注册用户总数
- **活跃用户**: 使用过短信接码的用户数
- **额度用完**: 已用完免费额度的用户数
- **总使用次数**: 所有用户累计使用次数

### 2. 用户列表

显示所有用户的详细SMS使用情况：

| 字段 | 说明 |
|------|------|
| 用户ID | 数据库用户ID |
| 邮箱 | 用户注册邮箱 |
| 昵称 | 用户昵称（如有） |
| 已使用 | 已使用的SMS次数 |
| 总额度 | 用户的SMS使用限制 |
| 剩余 | 剩余可用次数（绿色/红色标识） |
| 最后使用 | 最后一次使用SMS的时间 |
| 操作 | 修改按钮 |

**特性**:
- 按使用次数降序排列
- 支持按邮箱/昵称搜索
- 分页显示（每页20条）
- 剩余次数颜色提示（0为红色）

### 3. 修改功能

点击用户行的"修改"按钮后：

1. **输入新额度**: 弹出对话框，输入新的总额度数字
2. **重置使用次数**: 选择是否将已使用次数归零
3. **确认修改**: 系统立即更新并刷新列表

## 使用场景

### 场景1: 用户发电增加额度

**示例**: 用户发电10元，按1元=1次计算

1. 在搜索框输入用户邮箱
2. 点击"搜索"
3. 找到用户，点击"修改"
4. 计算新额度：`当前额度 + 10`（例如：3 + 10 = 13）
5. 输入新额度：`13`
6. 选择"取消"（不重置已使用次数）
7. 确认

### 场景2: VIP用户无限使用

**示例**: 大额赞助用户，设置为无限

1. 找到用户
2. 点击"修改"
3. 输入新额度：`999999`
4. 确认

### 场景3: 重置用户使用次数

**示例**: 用户反馈问题，重新给予免费额度

1. 找到用户
2. 点击"修改"
3. 输入新额度：`3`（或其他值）
4. 选择"确定"（重置使用次数为0）
5. 确认

### 场景4: 批量搜索管理

**示例**: 查找所有使用过SMS的用户

1. 保持搜索框为空
2. 点击"重置"
3. 列表自动按使用次数排序，活跃用户在前

## 建议的额度对应关系

| 发电金额 | 增加次数 | 计算方式 | 备注 |
|---------|---------|---------|------|
| 10元 | 10次 | 1元=1次 | 基础支持 |
| 20元 | 25次 | 1元=1.25次 | 优惠25% |
| 50元 | 100次 | 1元=2次 | 优惠100% |
| 100元 | 300次 | 1元=3次 | 优惠200% |
| 500元+ | 999999次 | 无限 | VIP待遇 |

## API接口说明

### 获取统计信息

```
GET /api/admin/sms-stats
Authorization: Bearer {token}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "totalUsers": 100,
    "activeUsers": 25,
    "usersAtLimit": 10,
    "totalUsage": 85
  }
}
```

### 获取用户列表

```
GET /api/admin/sms-users?page=1&limit=20&search=user@example.com
Authorization: Bearer {token}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "users": [
      {
        "id": 1,
        "email": "user@example.com",
        "nickname": "User",
        "smsUsageCount": 2,
        "smsUsageLimit": 3,
        "smsLastUsedAt": "2025-12-20T05:30:00.000Z",
        "createdAt": "2025-12-01T10:00:00.000Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 100,
      "totalPages": 5
    }
  }
}
```

### 修改用户额度

```
POST /api/admin/sms-users/:userId/update-limit
Authorization: Bearer {token}
Content-Type: application/json

{
  "limit": 10,
  "resetCount": false
}
```

**参数**:
- `limit`: 新的额度限制（非负整数）
- `resetCount`: 是否重置已使用次数（boolean）

**响应**:
```json
{
  "success": true,
  "message": "已更新用户 user@example.com 的SMS额度",
  "data": {
    "smsUsageCount": 2,
    "smsUsageLimit": 10
  }
}
```

## 安全说明

### 权限验证

1. **后端验证**: 
   - `requireAdmin` 中间件检查邮箱白名单
   - 非授权用户返回403错误

2. **前端验证**:
   - `initAdmin` 函数检查用户邮箱
   - 非授权用户自动重定向到首页

### 操作日志

所有管理操作都会记录到PM2日志：

```bash
# 查看实时日志
pm2 logs mirror-api

# 查看最近50行
pm2 logs mirror-api --lines 50

# 只查看错误日志
pm2 logs mirror-api --err
```

日志格式示例：
```
[Admin] Get SMS users failed: ...
[Admin] Update SMS limit failed: ...
```

### 数据安全

- 所有操作需要JWT认证
- 用户缓存自动清除（Redis）
- 数据库事务保证一致性

## 故障排查

### 问题1: 无法访问管理后台

**症状**: 显示"仅限站长访问"

**原因**: 
1. 使用的不是授权邮箱
2. 未登录或Token过期

**解决**:
1. 使用violet@yljdteam.com或1494458927@qq.com登录
2. 清除缓存后重新登录

### 问题2: 列表显示"加载失败"

**症状**: 用户列表无法加载

**原因**:
1. 数据库字段未添加
2. API服务异常

**解决**:
1. 执行数据库迁移脚本
2. 检查API服务：`pm2 status`
3. 查看日志：`pm2 logs mirror-api`

### 问题3: 修改后不生效

**症状**: 修改额度后用户仍无法使用

**原因**:
1. 用户需要刷新页面
2. 前端缓存未清除

**解决**:
1. 告知用户刷新页面
2. 用户重新登录

## 维护建议

### 定期检查

建议每周检查：

1. **统计面板**: 查看总体使用情况
2. **额度用完用户**: 关注需要增加额度的用户
3. **活跃用户**: 了解用户活跃度

### 处理流程

用户发电后的处理流程：

1. **接收发电通知**（微信/支付宝）
2. **确认金额和用户邮箱**
3. **登录管理后台**
4. **搜索用户**
5. **计算新额度**（当前额度 + 发电对应次数）
6. **执行修改**
7. **通知用户**（可选）

### 记录保存

建议保留以下记录：

- 发电用户邮箱
- 发电金额
- 增加次数
- 操作时间

可以使用Excel或在线表格记录，方便审计和查询。

## 联系方式

如需修改管理员列表或遇到问题：

**QQ**: 1494458927

**修改管理员白名单**:
```javascript
// 文件: /var/www/mirror/api/src/routes/admin.js
const ADMIN_EMAILS = ['1494458927@qq.com', 'violet@yljdteam.com'];
```

添加新管理员后需要重启API服务：
```bash
pm2 restart mirror-api
```

