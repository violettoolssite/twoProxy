# P2P 文件传输功能

## 📋 功能说明

P2P 文件传输功能使用 WebRTC 技术实现点对点文件传输，支持端到端加密，无需经过服务器中转文件，安全快速。

## ✨ 功能特性

- ✅ **点对点直连**：文件直接在两个客户端之间传输，不经过服务器
- ✅ **端到端加密**：使用 AES-GCM 256位加密，确保传输安全
- ✅ **大文件支持**：支持任意大小的文件传输（分块传输）
- ✅ **实时进度**：实时显示文件传输进度
- ✅ **房间管理**：通过房间ID连接，支持创建和加入房间
- ✅ **自动重连**：连接断开时自动清理资源

## 🚀 使用方法

### 1. 创建房间（发送方）

1. 访问网站，点击导航栏中的"P2P传输"
2. 点击"创建房间"按钮
3. 系统会自动生成房间ID并显示
4. 将房间ID分享给接收方
5. 选择要发送的文件（支持拖拽）
6. 文件会自动开始传输

### 2. 加入房间（接收方）

1. 访问网站，点击导航栏中的"P2P传输"
2. 点击"加入房间"按钮
3. 输入发送方提供的房间ID
4. 等待连接建立
5. 文件会自动接收并下载

## 🔧 技术实现

### 前端

- **WebRTC DataChannel**：用于点对点数据传输
- **WebSocket**：用于信令交换（房间创建、ICE候选交换等）
- **Web Crypto API**：用于端到端加密（AES-GCM）
- **文件分块**：大文件自动分块传输（16KB/块）

### 后端

- **Express**：HTTP服务器
- **WebSocket Server**：信令服务器，处理房间管理和消息中继
- **房间管理**：自动清理过期房间（30分钟）

### 加密流程

1. 连接建立时，双方各自生成加密密钥
2. 发送方使用密钥加密文件块
3. 接收方使用密钥解密文件块
4. 密钥不经过服务器，确保端到端安全

## 📁 文件结构

```
/var/www/mirror/
├── index.html              # P2P传输页面UI
├── js/
│   └── p2p.js             # P2P传输前端逻辑
└── api/
    └── src/
        └── routes/
            └── p2p.js      # P2P信令服务器
```

## 🔌 API 端点

### WebSocket 信令服务器

- **路径**: `/api/p2p/signaling`
- **协议**: WebSocket
- **消息类型**:
  - `join`: 加入房间
  - `offer`: WebRTC offer
  - `answer`: WebRTC answer
  - `ice-candidate`: ICE候选
  - `peer-ready`: 对端就绪
  - `peer-disconnected`: 对端断开

### HTTP API

- `GET /api/p2p/rooms/:roomId`: 获取房间信息
- `GET /api/p2p/stats`: 获取统计信息

## ⚠️ 注意事项

1. **NAT穿透**：使用STUN服务器进行NAT穿透，某些网络环境可能无法建立直连
2. **浏览器兼容性**：需要支持WebRTC的现代浏览器（Chrome、Firefox、Edge等）
3. **文件大小**：理论上无限制，但受浏览器内存限制
4. **连接稳定性**：P2P连接可能受网络环境影响，建议在稳定的网络环境下使用

## 🐛 故障排除

### 无法建立连接

1. 检查网络连接
2. 确认防火墙允许WebRTC流量
3. 尝试刷新页面重新连接

### 文件传输失败

1. 检查浏览器控制台错误信息
2. 确认文件大小不超过浏览器限制
3. 尝试传输较小的文件测试连接

### 加密失败

1. 检查浏览器是否支持Web Crypto API
2. 确认浏览器版本足够新
3. 如果加密失败，系统会自动使用未加密传输

## 📝 更新日志

- **2025-01-30**: 初始版本发布
  - 支持P2P文件传输
  - 端到端加密
  - 房间管理
  - 实时进度显示

