# 短信接码服务集成文档

## 概述

本项目已集成好助码（haozhuma）短信接码服务，为用户提供临时手机号接收短信验证码功能。

## API文档参考

- **官方文档**: https://www.showdoc.com.cn/haozhuma/9627395812080888
- **服务器地址**: 
  - 主线路: `https://api.haozhuma.com`
  - 备用线路: `https://api.haozhuyun.com`

## 配置步骤

### 1. 获取API账号

1. 访问好助码平台并注册账号
2. 登录后进入"API开发"页面
3. 获取API账号（用户名）和API密码

### 2. 配置环境变量

在 `/var/www/mirror/api/.env` 文件中添加以下配置：

```bash
# 短信接码API配置（好助码平台）
SMS_API_URL=https://api.haozhuma.com
SMS_API_USER=你的API用户名
SMS_API_PASS=你的API密码
```

### 3. 重启API服务

```bash
cd /var/www/mirror/api
pm2 restart mirror-api
```

## 功能说明

### 前端功能

1. **项目选择**: 仅支持Cursor项目
   - 使用专属对接码 `78720-R7QEQDSSK3`
   - 页面已隐藏项目选择框，自动使用Cursor项目
2. **高级选项**: 
   - 运营商选择：移动、联通、电信
   - 号码类型：不限、只取类似、只取实卡
3. **获取手机号**: 点击按钮获取临时手机号
   - 自动限制价格在0.5元以内
   - 只获取性价比高的号码
4. **释放全部**: 一键释放所有未释放的号码
   - 解决"取号已超限A"问题
   - 操作前会弹出确认对话框
5. **查看验证码**: 自动刷新（每5秒）接收到的验证码
6. **释放号码**: 不再需要时可以手动释放单个号码
7. **历史记录**: 保存最近使用的10个号码，方便快速复制
8. **默认选择**: 页面加载时自动选中Cursor项目

### 后端API

#### 1. 获取项目列表
```
GET /api/sms/projects
```

返回常用项目列表（如OpenAI、GitHub、Google等30+项目）。

#### 2. 获取手机号
```
GET /api/sms/get-phone?sid=项目ID&isp=运营商&ascription=号码类型
```

参数：
- `sid`: 项目ID（必需）
- `isp`: 运营商（可选，1=移动，2=联通，3=电信）
- `ascription`: 号码类型（可选，1=只取类似，2=只取实卡）

#### 3. 获取验证码
```
GET /api/sms/get-message?sid=项目ID&phone=手机号
```

参数：
- `sid`: 项目ID（必需）
- `phone`: 手机号（必需）

#### 4. 释放手机号
```
POST /api/sms/release-phone
Body: { "sid": "项目ID", "phone": "手机号" }
```

释放单个不再使用的手机号。

#### 5. 释放全部手机号
```
POST /api/sms/release-all
```

一键释放账号下所有未释放的号码，无需提供任何参数。

**使用场景：**
- 当遇到"取号已超限A"错误时
- 需要批量清理未使用的号码时
- API自动使用 `cancelAllRecv` 接口

## 工作原理

### Token管理

- 首次调用时自动登录获取Token
- Token缓存23小时（好助码文档说明Token固定，除非修改密码）
- Token过期后自动重新登录

### API调用流程

1. **获取Token**: 使用API账号和密码登录，获取Token
2. **获取手机号**: 使用Token和项目ID请求临时手机号
3. **查询验证码**: 使用Token、项目ID和手机号查询收到的验证码
4. **释放号码**: 不需要时释放号码，避免资源浪费

### 前端交互

1. 用户选择项目类型和高级选项
2. 点击"获取手机号"按钮
3. 前端调用 `/api/sms/get-phone` 获取手机号
4. 显示手机号，用户可以复制使用
5. 点击"查看验证码"按钮
6. 前端每5秒自动调用 `/api/sms/get-message` 查询验证码
7. 收到验证码后停止自动刷新，显示验证码和完整短信内容
8. 用户可以一键复制验证码
9. 不需要时点击"释放号码"按钮释放资源

## 项目列表

系统内置30+常用项目：

系统当前仅支持Cursor项目：

- **项目**: Cursor
- **项目ID (sid)**: `78720`
- **号码来源**: 通用号码池（不使用对接码）
- **特点**: 正规中国大陆手机号，质量稳定

### API调用参数说明

当用户选择Cursor项目时，后端API会自动构造以下参数：
```
api=getPhone
token=<自动获取>
sid=78720           # 项目ID，标识Cursor项目
max_money=0.5       # 限制最高价格为0.5元
```

**号码质量保证：**
- ✅ **中国大陆正规手机号**：13x/14x/15x/16x/17x/18x/19x 开头
- 💰 **价格控制**：自动限制在0.5元以内，避免高价号码
- ✅ **真实运营商**：移动、联通、电信、广电
- ✅ **真实归属地**：河南洛阳、广东深圳等
- ✅ **11 位纯数字**：符合中国大陆手机号规范

**重要说明：**
- ⚠️ **不使用对接码**：经测试，对接码 `78720-R7QEQDSSK3` 的号码池质量较差（包含大量316虚拟号码和852香港号码），因此改用项目通用号码池，质量更好、更稳定。

## 注意事项

1. **有效期**: 每个号码有效期约10-15分钟，请及时查看验证码
2. **资源管理**: 不需要时请及时释放号码，避免资源浪费
3. **API限流**: 好助码平台可能有API调用频率限制，请合理使用
4. **错误处理**: 如果长时间未收到验证码，可以释放号码后重新获取
5. **隐私保护**: 临时号码仅用于接收验证码，不要用于重要账号注册

## 故障排查

### 1. 无法获取手机号

- 检查环境变量配置是否正确
- 检查API账号余额是否充足
- 检查网络连接是否正常
- 查看API服务日志: `pm2 logs mirror-api`

### 2. 无法收到验证码

- 等待更长时间（某些服务发送验证码较慢）
- 释放当前号码，重新获取
- 尝试更换运营商或号码类型
- 检查项目ID是否正确

### 3. Token失效

- Token会自动刷新，无需手动处理
- 如果频繁出现Token失效，检查API账号密码是否正确
- 检查系统时间是否准确

## 文件结构

```
/var/www/mirror/
├── index.html                    # 主页（包含短信接码页面）
├── user/index.html              # 用户中心（包含导航链接）
├── admin/index.html             # 管理后台（包含导航链接）
├── js/app.js                    # 前端逻辑（包含短信接码功能）
├── api/
│   ├── src/
│   │   ├── app.js              # API主文件（注册短信路由）
│   │   ├── routes/
│   │   │   └── sms.js          # 短信接码API路由
│   │   └── config/
│   │       └── env.example.js  # 环境变量示例（包含SMS配置）
│   └── .env                     # 环境变量（需手动配置）
└── SMS_INTEGRATION.md           # 本文档
```

## 维护建议

1. **定期检查**: 定期检查API账号余额和使用情况
2. **日志监控**: 监控API调用日志，及时发现异常
3. **用户反馈**: 收集用户反馈，优化项目列表和使用体验
4. **备用方案**: 配置备用服务器地址，提高服务可用性

## 联系支持

- **好助码平台**: 访问官方文档或联系客服
- **项目问题**: 查看项目README或提交Issue

