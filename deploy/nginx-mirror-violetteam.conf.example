# Mirror 加速站 - mirror.violetteam.cloud 专用配置
# 用于CDN配置后的域名访问
# 
# 功能: 与 mirror.yljdteam.com 相同的功能，但使用不同的域名
#
# 安装方式:
#   sudo cp nginx-mirror-violetteam.conf.example /etc/nginx/sites-enabled/mirror-violetteam.conf
#   sudo nginx -t
#   sudo systemctl reload nginx

server {
    listen 443 ssl http2;
    server_name mirror.violetteam.cloud;

    root /var/www/mirror;
    index index.html;
    client_max_body_size 0;

    # SSL 证书
    ssl_certificate     /etc/letsencrypt/live/mirror.violetteam.cloud/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mirror.violetteam.cloud/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # DNS 解析（强制 IPv4，避免 IPv6 连接失败）
    resolver 8.8.8.8 1.1.1.1 valid=300s ipv6=off;
    resolver_timeout 5s;

    # ========= 首页 / 用户中心 / API =========

    # 重置密码单独页面
    location = /user/reset-password {
        root /var/www/mirror;
        try_files /user/reset-password.html =404;
    }

    # 用户中心及相关子页面
    location ^~ /user/ {
        root /var/www/mirror;
        try_files $uri $uri/ /user/index.html;
    }

    # 站长后台
    location ^~ /admin/ {
        root /var/www/mirror;
        try_files $uri $uri/ /admin/index.html;
    }

    # 后端 API 代理
    location ^~ /api/ {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ========= GitHub API 搜索代理 =========
    location ~ ^/gh/search/(.+)$ {
        set $api_path $1;
        proxy_pass https://api.github.com/search/$api_path$is_args$args;
        proxy_set_header Host api.github.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_ssl_server_name on;
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_http_version 1.1;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;
    }
    
    # ========= Docker Hub API 搜索代理 =========
    location = /v2/search/ {
        proxy_pass https://hub.docker.com/v2/search/;
        proxy_set_header Host hub.docker.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header User-Agent "Docker-Client/25.0 (mirror.violetteam.cloud)";
        proxy_set_header Accept "application/json";
        proxy_ssl_server_name on;
        proxy_http_version 1.1;
    }

    # ========= Docker Registry 认证代理 =========
    location ~ ^/docker-auth/(.+)$ {
        set $auth_path $1;
        proxy_pass https://auth.docker.io/$auth_path$is_args$args;
        proxy_set_header Host auth.docker.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_ssl_server_name on;
        proxy_http_version 1.1;
    }

    # ========= Docker Hub Registry 代理 =========
    location ~ ^(?!/file/)/v2/(.+)$ {
        set $registry_path $1;
        proxy_pass https://registry-1.docker.io/v2/$registry_path$is_args$args;
        proxy_set_header Host registry-1.docker.io;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header Authorization $http_authorization;
        proxy_ssl_server_name on;
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_http_version 1.1;
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # ========= 通用文件代理（HTTPS 源站）=========
    location ~ ^/file/https/([^/]+)(/.*)$ {
        set $dst_host $1;
        set $dst_path $2;
        proxy_set_header Host $dst_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_ssl_server_name on;
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_http_version 1.1;
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        proxy_pass https://$dst_host$dst_path$is_args$args;
    }

    # ========= GitHub 路径代理 =========
    # 重要：排除更多路径，避免误匹配
    location ~ ^/([^/]+/[^/]+)(/.*)?$ {
        set $owner_repo $1;
        set $sub_path $2;
        if ($sub_path = "") {
            set $sub_path "/";
        }
        # 排除已知的非 GitHub 路径（添加更多排除项）
        if ($owner_repo ~ ^(css|js|file|assets|api|user|admin|_next|static|favicon\.ico|github|search|v2|gh|sponsors|hunshcn|gh-proxy|violetteam|mirror)) {
            break;
        }
        # 代理到 GitHub
        proxy_pass https://github.com/$owner_repo$sub_path$is_args$args;
        proxy_set_header Host github.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_ssl_server_name on;
        proxy_buffering on;
        proxy_buffer_size 32k;
        proxy_buffers 16 32k;
        proxy_busy_buffers_size 64k;
        proxy_request_buffering on;
        proxy_http_version 1.1;
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        proxy_hide_header Content-Security-Policy;
        proxy_hide_header X-Content-Security-Policy;
        proxy_hide_header X-WebKit-CSP;
        proxy_hide_header Content-Security-Policy-Report-Only;
        add_header Content-Security-Policy "default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src *; style-src * 'unsafe-inline'; img-src * data:; font-src * data:; frame-src *; object-src *; media-src *; worker-src * blob:;" always;
        sub_filter_types text/html;
        sub_filter_once off;
        sub_filter 'script-src github.githubassets.com' 'script-src * unsafe-inline unsafe-eval github.githubassets.com *.violetteam.cloud mirror.violetteam.cloud';
        sub_filter "connect-src 'self'" "connect-src * 'self'";
        sub_filter 'src="https://github.com/' 'src="/';
        sub_filter '<head>' '<head><script src="/js/release-fix.js"></script>';
    }

    # ========= 主页 =========
    location = / {
        try_files /index.html =404;
    }

    # ========= 静态资源 =========
    location ^~ /css/ {
        access_log off;
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
        try_files $uri =404;
    }

    location ^~ /js/ {
        access_log off;
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
        try_files $uri =404;
    }

    # ========= 其他静态文件 =========
    location / {
        try_files $uri $uri/ /index.html;
    }

    # ========= 安全相关 HTTP 头 =========
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
}

# ============ HTTP 重定向到 HTTPS ============
server {
    listen 80;
    server_name mirror.violetteam.cloud;
    return 301 https://$host$request_uri;
}

