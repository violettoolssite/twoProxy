# ============================================================
# Mirror 加速站 Nginx 配置
# 包含：主域名 + 通配符子域名 + API 代理
# ============================================================

# ============ 通配符子域名服务器块（付费用户专属）============
server {
    listen 443 ssl;
    http2 on;
    server_name "~^(?<subdomain>[a-z][a-z0-9]{2,19})\.mirror\.yljdteam\.com$";

    # 通配符 SSL 证书
    ssl_certificate /etc/letsencrypt/live/mirror.yljdteam.com-0001/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mirror.yljdteam.com-0001/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    root /var/www/mirror;
    index index.html;
    client_max_body_size 0;

    resolver 8.8.8.8 1.1.1.1 valid=300s;
    resolver_timeout 5s;

    # -------- 鉴权（通过后端 API 验证子域名和流量）--------
    location = /_auth {
        internal;
        proxy_pass http://127.0.0.1:3000/api/internal/auth;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-Subdomain $subdomain;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 5s;
        proxy_read_timeout 5s;
    }

    # -------- GitHub 仓库代理 --------
    location ~ ^/([^/]+/[^/]+)(/.*)?$ {
        auth_request /_auth;
        auth_request_set $auth_user $upstream_http_x_user_id;
        auth_request_set $auth_limit $upstream_http_x_rate_limit;

        # 根据套餐限速
        limit_rate $auth_limit;

        set $owner_repo $1;
        set $sub_path $2;
        if ($sub_path = "") {
            set $sub_path "/";
        }

        # 排除非 GitHub 路径
        if ($owner_repo ~ ^(css|js|file|assets|api|user|_next|static|favicon\.ico|gh|v2)) {
            break;
        }

        proxy_pass https://github.com/$owner_repo$sub_path$is_args$args;
        proxy_set_header Host github.com;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept $http_accept;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_ssl_server_name on;
        proxy_buffering on;
        proxy_buffer_size 32k;
        proxy_buffers 16 32k;
        proxy_busy_buffers_size 64k;
        proxy_http_version 1.1;
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        proxy_hide_header Content-Security-Policy;
        proxy_hide_header X-Content-Security-Policy;
        add_header Content-Security-Policy "default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;" always;
        
        sub_filter_types text/html;
        sub_filter_once off;
        sub_filter 'src="https://github.com/' 'src="/';
        sub_filter '<head>' '<head><script src="/js/release-fix.js"></script>';
    }

    # -------- 通用文件代理 --------
    location ~ ^/file/(https?)/(.+)$ {
        auth_request /_auth;
        auth_request_set $auth_limit $upstream_http_x_rate_limit;
        limit_rate $auth_limit;

        set $proto $1;
        set $target $2;
        
        proxy_pass $proto://$target$is_args$args;
        proxy_set_header Host $proxy_host;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_ssl_server_name on;
        proxy_buffering on;
        proxy_http_version 1.1;
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # -------- 静态文件 --------
    location ^~ /css/ {
        access_log off;
        expires 7d;
        try_files $uri =404;
    }

    location ^~ /js/ {
        access_log off;
        expires 7d;
        try_files $uri =404;
    }

    location / {
        try_files $uri $uri/ /index.html;
    }
}

# ============ 主域名服务器块（公共访问）============
server {
    listen 443 ssl;
    http2 on;
    server_name mirror.yljdteam.com ai.yljdteam.com;

    # 使用通配符证书
    ssl_certificate /etc/letsencrypt/live/mirror.yljdteam.com-0001/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mirror.yljdteam.com-0001/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    root /var/www/mirror;
    index index.html;
    client_max_body_size 0;

    resolver 8.8.8.8 1.1.1.1 valid=300s;
    resolver_timeout 5s;

    # 全局限速（免费用户：5 Mbps = 625 KB/s）
    limit_rate 625k;

    # -------- 后端 API 代理 --------
    location /api/ {
        limit_rate 0;  # API 不限速
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # -------- 用户中心 --------
    location /user/ {
        try_files $uri $uri/ /user/index.html;
    }

    # -------- GitHub API 搜索代理 --------
    location ~ ^/gh/search/(.+)$ {
        set $api_path $1;
        proxy_pass https://api.github.com/search/$api_path$is_args$args;
        proxy_set_header Host api.github.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_ssl_server_name on;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;
    }
    
    # -------- GitHub 路径代理 --------
    location ~ ^/([^/]+/[^/]+)(/.*)?$ {
        set $owner_repo $1;
        set $sub_path $2;
        if ($sub_path = "") {
            set $sub_path "/";
        }
        if ($owner_repo ~ ^(css|js|file|assets|api|user|_next|static|favicon\.ico|gh|v2)) {
            break;
        }
        proxy_pass https://github.com/$owner_repo$sub_path$is_args$args;
        proxy_set_header Host github.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_ssl_server_name on;
        proxy_buffering on;
        proxy_buffer_size 32k;
        proxy_buffers 16 32k;
        proxy_busy_buffers_size 64k;
        proxy_http_version 1.1;
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        proxy_hide_header Content-Security-Policy;
        proxy_hide_header X-Content-Security-Policy;
        proxy_hide_header X-WebKit-CSP;
        proxy_hide_header Content-Security-Policy-Report-Only;
        add_header Content-Security-Policy "default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src *; style-src * 'unsafe-inline'; img-src * data:; font-src * data:; frame-src *; object-src *; media-src *; worker-src * blob:;" always;
        sub_filter_types text/html;
        sub_filter_once off;
        sub_filter 'script-src github.githubassets.com' 'script-src * unsafe-inline unsafe-eval github.githubassets.com *.yljdteam.com ai.yljdteam.com mirror.yljdteam.com';
        sub_filter "connect-src 'self'" "connect-src * 'self'";
        sub_filter 'src="https://github.com/' 'src="/';
        sub_filter '<head>' '<head><script src="/js/release-fix.js"></script>';
    }

    location = / {
        try_files /index.html =404;
    }

    # -------- 静态资源 --------
    location ^~ /css/ {
        access_log off;
        expires 7d;
        try_files $uri =404;
    }

    location ^~ /js/ {
        access_log off;
        expires 7d;
        try_files $uri =404;
    }

    # -------- Ollama 安装脚本 --------
    location = /file/https/ollama.com/install.sh {
        default_type text/x-sh;
        root /var/www/mirror;
        try_files /ollama-install.sh =404;
    }

    # -------- 脚本代理 --------
    location ~ ^/file/https/([^/]+)(/.*\.sh)$ {
        set $dst_host $1;
        set $dst_path $2;
        proxy_set_header Host $dst_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_ssl_server_name on;
        proxy_set_header Accept-Encoding "";
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        proxy_pass https://$dst_host$dst_path$is_args$args;
        proxy_redirect https://github.com/ https://mirror-download.yljdteam.com/github.com/;
        sub_filter_once off;
        sub_filter_types *;
        sub_filter 'https://ollama.com/' 'https://mirror.yljdteam.com/file/https/ollama.com/';
        sub_filter 'https://github.com/' 'https://mirror-download.yljdteam.com/github.com/';
    }

    # -------- 通用文件代理 --------
    location ~ ^/file/https/([^/]+)(/.*)$ {
        set $dst_host $1;
        set $dst_path $2;
        proxy_set_header Host $dst_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_ssl_server_name on;
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        proxy_pass https://$dst_host$dst_path$is_args$args;
    }

    # -------- Docker Hub API --------
    location /v2/search/ {
        proxy_pass https://hub.docker.com;
        proxy_set_header Host hub.docker.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header User-Agent "Docker-Client/25.0 (mirror.yljdteam.com)";
        proxy_set_header Accept "application/json";
        proxy_ssl_server_name on;
        proxy_http_version 1.1;
    }

    location /gh/ {
        rewrite ^/gh/(.*)$ /$1 break;
        proxy_pass https://api.github.com;
        proxy_set_header Host api.github.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_ssl_server_name on;
        proxy_http_version 1.1;
    }
}

# ============ HTTP 重定向 ============
server {
    listen 80;
    server_name mirror.yljdteam.com *.mirror.yljdteam.com ai.yljdteam.com;
    return 301 https://$host$request_uri;
}

